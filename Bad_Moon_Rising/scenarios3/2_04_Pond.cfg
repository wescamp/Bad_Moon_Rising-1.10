#textdomain wesnoth-Bad_Moon_Rising
[scenario]
    id="2_04_Pond"
    name= _ "Mirror Pond"
    map_data="{~add-ons/Bad_Moon_Rising/maps/2_04_Pond3.map}"
    next_scenario=2_04_World
    victory_when_enemies_defeated=no
    {TURNS 44 40 36}

    [music]
        #	name="the_deep_path.ogg"
        name="nunc_dimittis.ogg"
    [/music]

    {BMR_FROST}
#    {BMR_WINTER}
    {BMR_FIRST_WATCH}

#define BMR_VULTURE_RING
	x,y=23,17
#enddef
#define BMR_FROZEN_QUEEN
	x,y=4-16,1-9
#enddef
	{BMR_DESPAIR_BONES 42 17 2}
	{BMR_DESPAIR_BONES 4 16 2}
	{BMR_DESPAIR_BONES 10 18 2}
	{BMR_DESPAIR_BONES 42 3 2}


    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Explore the Castle"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Belleros"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Hrala Gareth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Grat Gareth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Time runs out"
            [/objective]
            note= _ "This scenario should work, but is probably not balanced."
        [/objectives]
	[remove_shroud]
	x=1-44,1-11
	y=23-33,21-22
	side=1
	[/remove_shroud]
	{OBJ_POTION_DECAY 6 14 dec1}
	{OBJ_POTION_STRONG 7 15 str1}
	{OBJ_POTION_DECAY 8 15 dec2}
	{OBJ_POTION_STRONG 6 15 str2}
	{OBJ_POTION_POISON 5 15 psn1}
        [item]
            x=37
            y=16
            image="items/barrel.png"
        [/item]
        [item]
            x=12
            y=15
            image="items/barrel.png"
        [/item]
        [item]
            x=7
            y=18
            image="items/chest-plain-open.png"
        [/item]
        [item]
            x=32
            y=2
            image="units/huric-neutral.png~GS()"
        [/item]
        [item]
            x=25
            y=2
            image="units/despair/stone-alt.png~GS()"
        [/item]
        [item]
            x=28
            y=5
            image="units/despair/statue-alt.png~GS()"
        [/item]
        [item]
            x=28
            y=8
            image="units/despair/statue-alt.png~GS()"
        [/item]
        [item]
            x=35
            y=5
            image="units/despair/statue-alt.png~GS()"
        [/item]
        [item]
            x=35
            y=8
            image="units/despair/statue-alt.png~GS()"
        [/item]
        [item]
            x=36
            y=2
            image="units/despair/stone-alt.png~GS()"
        [/item]
        [item]
            x=29
            y=1
            image="units/despair/stone-alt.png~GS()"
        [/item]
        [item]
            x=20
            y=22
            image="scenery/snowbits.png"
        [/item]
        [item]
            x=18
            y=20
            image="scenery/snowbits.png"
        [/item]
        [item]
            x=15
            y=27
            image="scenery/snowbits.png"
        [/item]
        [item]
            x=6
            y=27
            image="scenery/snowbits.png"
        [/item]
        [item]
            x=8
            y=3
            image="misc/battleprincess-frozen.png"
        [/item]
        [item]
            x=6
            y=4
            image="misc/javelineer-frozen.png"
        [/item]
        [item]
            x=10
            y=5
            image="misc/spearman-frozen.png"
        [/item]
        [item]
	    {BMR_VULTURE_RING}
            image="items/ring-silver.png"
        [/item]
        [item]
            x=16
            y=8
            image="misc/bookshelf-fullSW.png"
        [/item]
        [item]
            x=17
            y=11
            image="misc/chairSW.png"
        [/item]
        [item]
            x=16
            y=11
            image="items/book5.png"
        [/item]
        [item]
            x=31
            y=2
            image="items/brazier.png"
        [/item]
        [item]
            x=33
            y=2
            image="items/brazier.png"
        [/item]
        [item]
            x=14
            y=8
            image="scenery/trash.png"
        [/item]
        	[store_unit]
        	    [filter]
        		id=Astreya
        	    [/filter]
        		variable=astreya
        		kill=yes
        	[/store_unit]
        	[store_unit]
        	    [filter]
        		id=Huric
        	    [/filter]
        		variable=huric
        		kill=yes
        	[/store_unit]
        [recall]
            id=Grat Gareth
        [/recall]
        [recall]
            id=Hrala Gareth
        [/recall]
# recalling the skirmish group
           [store_unit]  
                [filter]  
                    side=1
                    x,y=recall,recall
                [/filter]
                variable=maybe_recall
                kill=no  
           [/store_unit]
            {FOREACH maybe_recall ri}
                [if]
                    [variable]
                        name=maybe_recall[$ri].variables.on_call
                        equals=yes
                    [/variable]
                    [then]
                        [recall]
                            id=$maybe_recall[$ri].id
                        [/recall]
                    [/then]
                [/if]
            {NEXT ri}
            {CLEAR_VARIABLE maybe_recall}
        [set_variable]
            name=huric_summoning
            value=-2
        [/set_variable]
        {MODIFY_UNIT side=3 status.petrified yes}
        [set_variable]
            name=hypotherm
            value=0
        [/set_variable]
    [/event]

    [side]
        type=Ukian Subcommander
        id=C_Belleros
        name= _ "Belleros"
        profile="portraits/c_belleros.png"
        ellipse="misc/ellipse-hero"
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        unrenamable=yes
        side=1
        canrecruit=yes
        controller=human
        fog=yes
	shroud=yes
        recruit=Ukian Runner, Ukian Regular, Ukian Archer, Ukian Dog
        {GOLD 250 200 150}
        {INCOME 6 5 4}
        team_name=good
    [/side]

    [side]
        type=Phantom King
        id=Huric
        name= _ "Huric"
        side=2
        canrecruit=yes
        controller=ai
        fog=no
#ifdef EASY
        recruit=Phantom Cloak, Phantom Spearman, Phantom Unease
#endif
#ifdef NORMAL
        recruit=Phantom Cloak, Phantom Spearman, Phantom Rider, Phantom Unease
#endif
#ifdef HARD
        recruit=Phantom Cloak, Phantom Spearman, Phantom Rider, Phantom Statue, Phantom Unease
#endif
        {GOLD 420 500 580}
        {INCOME 10 14 18}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
            {BMR_AI_TARGET (id=C_Belleros) 60}
            {BMR_AI_TARGET (side=1) 20}
            {BMR_VILLAGE_VALUE 0}
            {BMR_AI_LOCPROTECT (x,y=22-34,17-29) 50 1}
            #	aggression=0.8
            #	grouping=offensive
            #	    [target]
            #		id=C_Belleros
            #		value=500
            #	    [/target]
            #	    [protect_location]
            #		x=22-34
            #		y=17-29
            #		value=500
            #	    [/protect_location]
            #	caution=0.9
        [/ai]
        team_name=Phantom
        [unit]
            type=Phantom Queen
            id=Astreya
            name="Queen Astreya"
            random_traits=yes
            x,y=9,4
        [/unit]
    [/side]

    [side]
        no_leader=yes
        side=3
        controller=ai
        fog=no
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 0.8}
            {BMR_AI_TARGET (side=2) 60}
            {BMR_AI_TARGET (side=1) 20}
            #	aggression=0.8
            #	grouping=offensive
            #	    [target]
            #		side=2
            #		value=500
            #	    [/target]
            #	    [target]
            #		side=1
            #		value=200
            #	    [/target]
            #	caution=0.8
        [/ai]
        team_name=Rogues
        [unit]
            type=Rogue
            generate_name=yes
            random_traits=yes
            halo=misc/rogue-frozen.png
            x,y=16,19
            facing=se
        [/unit]
        [unit]
            type=Bandit
            generate_name=yes
            random_traits=yes
            halo=misc/bandit-frozen.png
            x,y=22,15
            facing=se
        [/unit]
        [unit]
            type=Outlaw
            generate_name=yes
            random_traits=yes
            halo=misc/outlaw-frozen.png
            x,y=14,10
            facing=se
        [/unit]
        [unit]
            type=Rogue
            generate_name=yes
            random_traits=yes
            halo=misc/rogue-frozen.png
            x,y=29,20
            facing=se
        [/unit]
    [/side]

    [event]
        name=start
        [message]
            speaker=C_Belleros
            message = _ "What is this castle?  These are not settled lands, and this is not orcish construction."
        [/message]
        [message]
            speaker=Grat Gareth
            message = _ "What is that supposed to mean?  These lands don't need your type to be settled!"
        [/message]
        [message]
            speaker=Hrala Gareth
            message = _ "Calm down, Grat.  There is something very wrong with this place, we shouldn't distract ourselves."
        [/message]
        [message]
            speaker=C_Belleros
            message = _ "This place may be cursed, or it may be a place of power.  We need any edge we can get.  We should investigate."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=15-17,21-23,28-30
            y=19-20,16,19-20
            [not]
                race=ukiandog
            [/not]
            [not]
                id=C_Belleros
            [/not]
        [/filter]
        [message]
            speaker=unit
            message = _ "These people are frozen... But there are relatively recent footprints trailing their feet."
        [/message]
        [message]
            speaker=C_Belleros
            message = _ "Frozen where they stand! I've heard of it in fairytales, but never seen it before. These may be the assistants of that merchant... Do they wear silver rings?"
        [/message]
        [message]
            speaker=unit
            message = _ "Aye, they do."
        [/message]
        [message]
            speaker=C_Belleros
            message = _ "Then they are criminals. Vultures, we used to call them. They pick the valuables off the dead, even if they have to exhume a corpse from its burial."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
	    {BMR_VULTURE_RING}
            race=ukiandog
        [/filter]
        [message]
            speaker=unit
            message = _ "<i>(sniff, sniff... snort!)</i>"
        [/message]
    [/event]
    [event]
        name=moveto
        [filter]
            side=1
            x=16-25
            y=16-23
            race=ukiandog
        [/filter]
        [message]
            speaker=unit
            message = _ "<i>(sniff, sniff, sniff...)</i>"
        [/message]
    [/event]
    [event]
        name=moveto
        [filter]
            side=1
	    {BMR_FROZEN_QUEEN}
            race=ukiandog
        [/filter]
        [message]
            speaker=unit
            message = _ "<i>(sniff, sniff... Grrr...)</i>"
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
	    {BMR_VULTURE_RING}
            [not]
                race=ukiandog
            [/not]
            [not]
                id=C_Belleros
            [/not]
        [/filter]
        [message]
            speaker=unit
            message = _ "A silver ring... (<i>$unit.name| raises the ring to the starlight for a better view.</i>)"
        [/message]
        [message]
            speaker=C_Belleros
            message = _ "I've seen rings like that before. Band of the Vultures. Do not wear it, it is a brand of shame, but do hold onto it - it will be proof to the mountebank that we found his men."
        [/message]
        [set_variable]
            name=stone_ring
            value=1
        [/set_variable]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [not]
                id=C_Belleros
            [/not]
            [not]
                race=ukiandog
            [/not]
	    {BMR_FROZEN_QUEEN}
        [/filter]
        [message]
            speaker=unit
            message = _ "There is a coldness here worse than that of the harsh winds of the tundra, it chills my soul - there are figures in the frosty haze!"
        [/message]
        [message]
            speaker=C_Belleros
            message = _ "Be very careful!"
        [/message]
        {MOVE_UNIT id=C_Belleros 14 5}
	[remove_shroud]
	side=1
	x,y=5-12,1-7
	[/remove_shroud]
	[redraw][/redraw]
	[scroll_to]
	    x,y=6,4
	[/scroll_to]
	[delay]
	time=250
	[/delay]
        [message]
            speaker=C_Belleros
            message = _ "It looks like the Queen!  This place must have something to do with the ghosts hounding us."
        [/message]
	[music]
	name=the_city_falls.ogg
	immediate=yes
	append=no
	[/music]
	[remove_shroud]
	side=1
	x,y=28-36,1-7
	[/remove_shroud]
	{CLEAR_FOG 1 32 3 4}
	[redraw][/redraw]
	[scroll_to]
	    x,y=32,3
	[/scroll_to]
	[remove_item]
	    x,y=31,2
	[/remove_item]
	{BMR_BRAZIER 31 2}
	[remove_item]
	    x,y=33,2
	[/remove_item]
	{BMR_BRAZIER 33 2}
	[remove_item]
	    x,y=32,2
	[/remove_item]
	[unstore_unit]
	    variable=huric
	[/unstore_unit]
        [message]
            speaker=Huric
            message = _ "You once fought for me, Lorenzon.  But now you have joined the madmen and would destroy this kingdom..."
        [/message]
        [message]
            speaker=C_Belleros
            message = _ "(Hrmmm...)  That sounds familiar..."
        [/message]
        [message]
            speaker=Huric
            message = _ "...  The sun will rise upon Ukiah again, and upon your bleached skulls!"
        [/message]
	[music]
	name=siege_of_laurelmor.ogg
	immediate=no
	append=yes
	[/music]
	[music]
	name=weight_of_revenge.ogg
	immediate=no
	append=yes
	[/music]
	[remove_item]
	    x,y=25,2
	[/remove_item]
	[unit]
	side=2
	type=Phantom Stone
	x,y=25,2
	[/unit]
	[remove_item]
	    x,y=28,5
	[/remove_item]
	[unit]
	side=2
	type=Phantom Statue
	x,y=28,5
	[/unit]
	[remove_item]
	    x,y=28,8
	[/remove_item]
	[unit]
	side=2
	type=Phantom Statue
	x,y=28,8
	[/unit]
	[remove_item]
	    x,y=35,5
	[/remove_item]
	[unit]
	side=2
	type=Phantom Statue
	x,y=35,5
	[/unit]
	[remove_item]
	    x,y=35,8
	[/remove_item]
	[unit]
	side=2
	type=Phantom Statue
	x,y=35,8
	[/unit]
	[remove_item]
	    x,y=36,2
	[/remove_item]
	[unit]
	side=2
	type=Phantom Stone
	x,y=36,2
	[/unit]
	[remove_item]
	    x,y=29,1
	[/remove_item]
	[unit]
	side=2
	type=Phantom Stone
	x,y=29,1
	[/unit]
	[unit]
	side=2
	type=Phantom Soldier
	x,y=35,3
	[/unit]
	[unit]
	side=2
	type=Phantom Soldier
	x,y=29,3
	[/unit]
        [message]
            speaker=C_Belleros
            message = _ "This place is haunted, and I don't understand the ghosts.  It was wrong to come here, we should leave."
        [/message]
	[terrain]
	terrain=Wog
	x=18,20,17-21,17-19,23
	y=21,21,22,23,23
	[/terrain]
	{UNCLEAR_FOG}
        [objectives]
            side=1
            [objective]
                condition=win
                description=_ "Escape the Castle"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Belleros"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Hrala Gareth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of Grat Gareth"
            [/objective]
            [objective]
                condition=lose
                description=_ "Time runs out"
            [/objective]
        [/objectives]
	[set_variable]
	    name=frost_gate
	    value=1
	[/set_variable]
    [/event]

#ifdef __UNUSED__
# Yfra doesn't kill, but it does mark for hypothermia
    [event]
	name=new turn
	first_time_only=no
           [store_unit]  
                [filter]  
                    side=1
		    [filter_location]
			terrain=*^Yfra
		    [/filter_location]
                [/filter]
                variable=freezing_unit
                kill=no  
           [/store_unit]
            {FOREACH freezing_unit ri}
                [if]
                    [variable]
                        name=freezing_unit[$ri].variables.freezing
                        equals=yes
                    [/variable]
                    [then]
                    [/then]
		    [else]
			[set_variable]
			name=freezing_unit[$ri].variables.freezing
			value=yes
			[/set_variable]
			[unstore_unit]
			variable=freezing_unit[$ri]
			find_vacant=no
			[/unstore_unit]
			[unit_overlay]
			x,y=$freezing_unit[$ri].x,$freezing_unit[$ri].y	
			image=misc/icy.png
			[/unit_overlay]
		    [/else]
                [/if]
            {NEXT ri}
            {CLEAR_VARIABLE freezing_unit}
    [/event]

# Yfro kills, and marks for hypothermia
    [event]
	name=new turn
	first_time_only=no
           [store_unit]  
                [filter]  
                    side=1
		    [filter_location]
			terrain=*^Yfro
		    [/filter_location]
                [/filter]
                variable=freezing_unit
                kill=no  
           [/store_unit]
            {FOREACH freezing_unit ri}
                [if]
                    [variable]
                        name=freezing_unit[$ri].variables.freezing
                        equals=yes
                    [/variable]
                    [then]
                        [kill]
                            id=$freezing_unit[$ri].id
			    animate=no
			    fire_event=yes
                        [/kill]
			[item]
			x,y=$freezing_unit[$ri].x,$freezing_unit[$ri].y	
			image="$freezing_unit[$ri].image|~CS(-90,15,135)"
			[/item]
                    [/then]
		    [else]
			[set_variable]
			name=freezing_unit[$ri].variables.freezing
			value=yes
			[/set_variable]
			[unstore_unit]
			variable=freezing_unit[$ri]
			find_vacant=no
			[/unstore_unit]
			[unit_overlay]
			x,y=$freezing_unit[$ri].x,$freezing_unit[$ri].y	
			image=misc/icy.png
			[/unit_overlay]
		    [/else]
                [/if]
            {NEXT ri}
            {CLEAR_VARIABLE freezing_unit}
           [store_unit]  
                [filter]  
                    side=1
		    [not]
		    [filter_location]
			terrain=*^Yfro
		    [/filter_location]
		    [/not]
                [/filter]
                variable=warming_unit
                kill=no  
           [/store_unit]
            {FOREACH freezing_unit ri}
                [if]
                    [variable]
                        name=warming_unit[$ri].variables.freezing
                        equals=yes
                    [/variable]
                    [then]
			[set_variable]
			name=warming_unit[$ri].variables.freezing
			value=no
			[/set_variable]
			[unstore_unit]
			variable=warming_unit[$ri]
			find_vacant=no
			[/unstore_unit]
			[remove_unit_overlay]
			x,y=$warming_unit[$ri].x,$warming_unit[$ri].y	
			image=misc/icy.png
			[/remove_unit_overlay]
		    [/then]
                [/if]
            {NEXT ri}
            {CLEAR_VARIABLE warming_unit}
    [/event]	

#endif


    [event]
	name=moveto
	first_time_only=no
	[filter]
	side=1
	[not]
	   race=ukiandog
	[/not]
	x,y=13-27,17-22
	[/filter]
	[if]
	    [variable]
		name=frost_gate
		equals=1
	    [/variable]
	    [then]
	    [message]
		speaker=unit
		message= _ "The entrance is gone!  The ice is melted!"
	    [/message]
	    [set_variable]
		name=frost_gate
		add=1
	    [/set_variable]
	    [message]
		speaker=C_Belleros
		message= _ "Looks like we have to face our ghosts..."
	    [/message]
	    [message]
		speaker=Hrala Gareth
		message= _ "Is there anything we can use in the cold room?"
	    [/message]
	    [message]
		speaker=C_Belleros
		message= _ "I really don't know, but let us re-examine it."
	    [/message]
	    [/then]
	[/if]	    
    [/event]

    [event]
	name=moveto
	first_time_only=no
	[filter]
	    side=1
	    [not]
		race=ukiandog
	    [/not]
	    x,y=16,11
	[/filter]
	[if]
	    [variable]
		name=frost_gate
		equals=2
	    [/variable]
		[then]
		[remove_item]
		    x,y=16,11
		[/remove_item]
		[unit_overlay]
		    x,y=$x1,$y1
	            image="items/book5.png"
		[/unit_overlay]
		[store_unit]
		    [filter]
			x,y=$x1,$y1
		    [/filter]
		    variable=booker
		    kill=no
		[/store_unit]
		[message]
		    speaker=unit
		    message= _ "This book...  Much of it is written in a language I don't understand...  But not all of it.  It is a notebook of someone named Malevan, he was doing some sort of research.  This must be some of his doing."  
		[/message]
		[message]
		    speaker=C_Belleros
		    message= _ "Hrm, what can we do about it?  Let's take the book, it may have some answers about the ghosts."
		[/message]
		[message]
		    speaker=Grat Gareth
		    message= _ "Better if it had answers about how to get out of here."
		[/message]
		[set_variable]
		    name=frost_gate
		    add=1
		[/set_variable]
		[/then]
	    [/if]
    [/event]

    [event]
	name=new turn
	first_time_only=no
	[switch]
	    variable=frost_gate
	    [case]
		value=3
		[set_variable]
		    name=frost_gate
		    add=1
		[/set_variable]
		[replace_map]
		map="{~add-ons/Bad_Moon_Rising/maps/frost/frost1.map}"
		[/replace_map]
		[redraw][/redraw]
		[message]
		speaker=narrator
		image=wesnoth-icon.png
		message= _ "The air grew colder, and the frosty air becan to spread.  A disembodied voice seemed to whisper:  'This is the reward for thieves...'" 
		[/message]
		[message]
		speaker=C_Belleros
		message= _ "This gets better and better."
		[/message]
	    [/case]
	    [case]
		value=4
		[set_variable]
		    name=frost_gate
		    add=1
		[/set_variable]
		[replace_map]
		map="{~add-ons/Bad_Moon_Rising/maps/frost/frost2.map}"
		[/replace_map]
		[redraw][/redraw]
		[message]
		speaker=C_Belleros
		message= _ "The cursed frost is spreading."
		[/message]
		[message]
		speaker=Grat Garreth
		message= _ "All the more reason to find a way out of here"
		[/message]
	    [/case]
	    [case]
		value=5
		[set_variable]
		    name=frost_gate
		    add=1
		[/set_variable]
		[replace_map]
		map="{~add-ons/Bad_Moon_Rising/maps/frost/frost3.map}"
		[/replace_map]
		[redraw][/redraw]
		[unstore_unit]
		variable=astreya
		[/unstore_unit]
	    [/case]
	    [case]
		value=6
		[set_variable]
		    name=frost_gate
		    add=1
		[/set_variable]
		[replace_map]
		map="{~add-ons/Bad_Moon_Rising/maps/frost/frost4.map}"
		[/replace_map]
		[redraw][/redraw]
	    [/case]
	    [case]
		value=7
		[set_variable]
		    name=frost_gate
		    add=1
		[/set_variable]
		[replace_map]
		map="{~add-ons/Bad_Moon_Rising/maps/frost/frost5.map}"
		[/replace_map]
		[redraw][/redraw]
	    [/case]
	    [case]
		value=8
		[set_variable]
		    name=frost_gate
		    add=1
		[/set_variable]
		[replace_map]
		map="{~add-ons/Bad_Moon_Rising/maps/frost/frost6.map}"
		[/replace_map]
		[redraw][/redraw]
	    [/case]
	    [case]
		value=9
		[set_variable]
		    name=frost_gate
		    add=1
		[/set_variable]
		[replace_map]
		map="{~add-ons/Bad_Moon_Rising/maps/frost/frost7.map}"
		[/replace_map]
		[redraw][/redraw]
		[message]
		speaker=C_Belleros
		message= _ "We are caught in a trap, because we are presumed to be theives.  What if we could prove we were not?"
		[/message]
		[message]
		speaker=Grat Gareth
		message= _ "How would we do that?"
		[/message]
	    [/case]
	    [case]
		value=10
		[set_variable]
		    name=frost_gate
		    add=1
		[/set_variable]
		[replace_map]
		map="{~add-ons/Bad_Moon_Rising/maps/frost/frost8.map}"
		[/replace_map]
		[redraw][/redraw]
		[message]
		speaker=C_Belleros
		message= _ "There is an open chest near where the entrance was.  I'm going to hope it is a kind of switch we can use to open the entrance again.  Would returning the book there let us out?"
		[/message]
	    [/case]
	[/switch]
    [/event]

    [event]
	name=moveto
	first_time_only=no
	[filter]
	id=$booker.id
	x,y=7,18
	[/filter]
	[if]
	    [variable]
		name=frost_gate
		equals=11
	    [/variable]
		[then]
		[set_variable]
		    name=frost_gate
		    add=1
		[/set_variable]
		[message]
		speaker=narrator
		message= _ "$booker.name placed the evil looking book into the open chest."
		image=wesnoth-icon.png
		[/message]
		[remove_unit_overlay]
		x,y=$x1,$y1
		image="items/book5.png"
		[/remove_unit_overlay]
		[replace_map]
		map="{~add-ons/Bad_Moon_Rising/maps/frost/frost9.map}"
		[/replace_map]
		[redraw][/redraw]
		[message]
		speaker=Grat Gareth
		message= _ "The frost has almost closed in on us."
		[/message]	
		[message]
		speaker=C_Belleros
		message= _ "But the water is freezing over, we can escape."
		[/message]	
		[scroll_to]
		x,y=19,23
		[/scroll_to]
		[delay]
		time=150
		[/delay]
		[message]
		speaker=Hrala Gareth
		message= _ "This will be cutting it close, we orcs are not so quick on the ice."
		[/message]	
		[/then]
	[/if]
    [/event]

    [event]
	name=moveto
	first_time_only=no
	[filter]
	id=C_Belleros
	y=26-33
	[/filter]
	[if]
	    [variable]
		name=frost_gate
		equals=12
	    [/variable]
		[then]
		[message]
		speaker=C_Belleros
		message= _ "Glad to be rid of this place."
		[/message]	
		[replace_map]
		map="{~add-ons/Bad_Moon_Rising/maps/frost/frost10.map}"
		[/replace_map]
		[redraw][/redraw]
		[scroll_to]
		x,y=32,3
		[/scroll_to]
		[delay]
		time=150
		[/delay]
		[kill]
		side=2
		animate=no
		[/kill]
		[delay]
		time=150
		[/delay]
		[message]
		speaker=Grat Garath
		message= _ "Can the ghosts be frozen?"
		[/message]	
		[message]
		speaker=Grat Garath
		message= _ "I don't know, let's not stay here."
		[/message]	
		[set_variable]
		name=huricdead
		value=0
		[/set_variable]
		{CLEAR_VARIABLE huric_summoning}
		{CLEAR_VARIABLE hypotherm}
		{CLEAR_VARIABLE frost_gate}
		[endlevel]
		{CONTINUE}
		[/endlevel]		
		[/then]
	[/if]
    [/event]


    [event]
        name=die
        first_time_only=no
        [filter]
            id=Astreya
        [/filter]
        [if]
            [have_unit]
                id=Huric
            [/have_unit]
            [then]
                [message]
                    speaker=Huric
                    message = _ "I cannot lose her again... I must summon ..."
                [/message]
                [music]
                    name=the_city_falls.ogg
                    append=no
                    immediate=yes
                [/music]
                {TRANSFORM_UNIT id=Huric "Phantom King2"}
                {FULL_HEAL id=Huric}
                [message]
                    speaker=Hrala Gareth
                    message = _ "He looks distracted..."
                [/message]
                [message]
                    speaker=C_Belleros
                    message = _ "If he is in a weakend state, now is the time to strike!"
                [/message]
                [set_variable]
                    name=huric_summoning
                    value=4
                [/set_variable]
                [scroll_to_unit]
                    id=Huric
                [/scroll_to_unit]
                {BMR_FLOATING_TEXT id=Huric 100,100,255 "Summoning... ($huric_summoning|)"}
                [delay]
                    time=2000
                [/delay]
            [/then]
#            [else]
#                [endlevel]
#                    result=victory
#                [/endlevel]
#            [/else]
        [/if]
    [/event]

    [event]
        name=new turn
        first_time_only=no
        [set_variable]
            name=huric_summoning
            add=-1
        [/set_variable]
        [if]
            [variable]
                name=huric_summoning
                greater_than=-1
            [/variable]
            [have_unit]
                id=Huric
            [/have_unit]
            [then]
                [scroll_to_unit]
                    id=Huric
                [/scroll_to_unit]
                {BMR_FLOATING_TEXT id=Huric 100,100,255 "Summoning... ($huric_summoning|)"}
                [delay]
                    time=2000
                [/delay]
            [/then]
        [/if]
        [if]
            [variable]
                name=huric_summoning
                numerical_equals=-1
            [/variable]
            [then]
                {TRANSFORM_UNIT id=Huric "Phantom King"}
                {FULL_HEAL id=Huric}
                [music]
                    name=vengeful.ogg
                    append=no
                    immediate=yes
                [/music]
                [message]
                    speaker=Huric
                    message = _ "She is back... Time to die, traitors!"
                [/message]
                [unit]
                    side=2
                    type=Phantom Queen
                    id=Astreya
                    name="Queen Astreya"
                    random_traits=yes
                    x,y=31,10
                [/unit]
                {BMR_FLOATING_TEXT id=Astreya 100,100,255 "Summoned!"}
                [message]
                    speaker=Astreya
                    message = _ "We will destroy you!"
                [/message]
# there are no castle hexes, but I may change that.
                [gold]
                    side=2
                    amount=250
                [/gold]
            [/then]
        [/if]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Huric
        [/filter]
        [store_unit]
            [filter]
                id=Huric
            [/filter]
            variable=king_huric
            kill=yes
            animate=yes
        [/store_unit]
        [set_variable]
            name=king_huric.hitpoints
            value=$king_huric.max_hitpoints
        [/set_variable]
        [if]
            [have_unit]
                id=Astreya
            [/have_unit]
            [then]
                [music]
                    name=casualties_of_war.ogg
                    append=no
                    immediate=yes
                [/music]
                [unstore_unit]
                    variable=king_huric
                [/unstore_unit]
                [message]
                    speaker=Astreya
                    message = _ "I do not let my king fade so easily..."
                [/message]
            [/then]
#            [else]
#                [endlevel]
#                    result=victory
#                [/endlevel]
#            [/else]
        [/if]
    [/event]

#ifdef __UNUSED__
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                terrain=Ayb
            [/filter_location]
            [not]
                race=ukiandog
            [/not]
            # FLAG:  the poor AI cannot deal with this automatically, I need some FAI help...  TODO
            [or]
                type=Phantom Statue, Phantom Stone, Phantom Armor
                [filter_location]
                    terrain=Ayb
                [/filter_location]
            [/or]
        [/filter]
        # This would look silly for flying units, but the player should not have flying units.
        [terrain]
            terrain=Wo
            x,y=$x1,$y1
        [/terrain]
        [redraw][/redraw]
        [if]
            # F_AG:  this doesn't work, but I don't care enough to fix it now...
            # I think this is fixed.
            [variable]
                name=unit.side
                numerical_equals=1
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ "Uh-oh!"
                [/message]
                [if]
                    [variable]
                        name=hypotherm
                        numerical_equals=0
                    [/variable]
                    [then]
                        [message]
                            speaker=C_Belleros
                            message= _ "The water is so cold that it will kill all who fall through the ice. Be careful!"
                        [/message]
                        [set_variable]
                            name=hypotherm
                            add=1
                        [/set_variable]
                    [/then]
                [/if]
            [/then]
        [/if]
        # statues would not freeze to death, but they would sink to irrelevance
        [kill]
            x,y=$x1,$y1
            animate=yes
        [/kill]
    [/event]

#endif

    [event]
        name=die
        [filter]
            id=C_Belleros
        [/filter]
        [message]
            speaker=unit
            message= _ "Uhghh..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=die
        [filter]
            id=Grat Gareth
        [/filter]
        [message]
            speaker=unit
            message= _ "Grah..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=die
        [filter]
            id=Hrala Gareth
        [/filter]
        [message]
            speaker=unit
            message= _ "Grah..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=time over
        [music]
            name=transience.ogg
            immediate=yes
        [/music]
        [message]
            speaker=C_Belleros
            message= _ "I'm afraid the cold is getting to me, I feel so tired..."
        [/message]
        [endlevel]
            result=defeat
            music=transience.ogg
        [/endlevel]
    [/event]
[/scenario]
